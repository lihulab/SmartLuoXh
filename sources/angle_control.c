#include "main.h"
//-------------------------------------------------------
//卡尔曼滤波，波形基本可用
//-------------------------------------------------------
void Kalman_Filter(void)                        
{
	static  float Q_angle=0.001, Q_gyro=0.003, R_angle=0.5, dt=0.005;//注意：dt的取值为kalman滤波器采样时间;
	static float Pk[2][2] = { {1, 0 }, {0, 1 }};
	static float Pdot[4] ={0,0,0,0};
	static const float C_0 = 1;
	static float q_bias = 0, angle_err = 0, PCt_0, PCt_1, E, K_0, K_1, t_0, t_1;
	angle+=(gyro-q_bias) * dt;
	Pdot[0]=Q_angle - Pk[0][1] - Pk[1][0];
	Pdot[1]=- Pk[1][1];
	Pdot[2]=- Pk[1][1];
	Pdot[3]=Q_gyro;

	Pk[0][0] += Pdot[0] * dt;
	Pk[0][1] += Pdot[1] * dt;
	Pk[1][0] += Pdot[2] * dt;
	Pk[1][1] += Pdot[3] * dt;


	angle_err = gravity - angle;


	PCt_0 = C_0 * Pk[0][0];
	PCt_1 = C_0 * Pk[1][0];

	E = R_angle + C_0 * PCt_0;

	K_0 = PCt_0*1.0/ E;
	K_1 = PCt_1*1.0/ E;

	t_0 = PCt_0;
	t_1 = C_0 * Pk[0][1];

	Pk[0][0] -= K_0 * t_0;
	Pk[0][1] -= K_0 * t_1;
	Pk[1][0] -= K_1 * t_0;
	Pk[1][1] -= K_1 * t_1;


	angle        += K_0 * angle_err;
	q_bias        += K_1 * angle_err;
	//angular_speed = gyro-q_bias;//滤波后的角速度
}
//------------------------------------------------------
//互补滤波，参数未整定，没用
//------------------------------------------------------
void Complementary_Filter()
{
	static float dt = 0.005,t = 0.5,A = 0.92;
	//A = 0.98;//t/(t+dt);
	angle = A*(angle + gyro * dt) + (1-A)*(gravity);
}
//------------------------------------------------------
//获取加速度传感器零点
//------------------------------------------------------
void Get_Gravity_Zero()
{
	unsigned int i;
	gravity_zero = AD_Capture(1);
	for(i = 0;i <= 1000;i++)
	{
		gravity_zero = (int)(gravity_zero*0.9 + AD_Capture(0)*0.1);
	}
	UART_SendString(0,"get gravity zero point:");
	UART_Sendgraph(0,0,gravity_zero);
}
//------------------------------------------------------
//获取陀螺仪零点
//------------------------------------------------------
void Get_Gyro_Zero()
{
	unsigned int i;
	gyro_zero = AD_Capture(0);
	for(i = 0;i <= 1000;i++)
	{
		gyro_zero = (int)(gyro_zero*0.9 + AD_Capture(1)*0.1);
	}
	UART_SendString(0,"get gyro zero point:");
	UART_Sendgraph(0,0,gyro_zero);
}
//------------------------------------------------------
//获取加速度计得出的角度值（正为向前）
//------------------------------------------------------
void Get_Gravity(void)
{
	uint8 i;
	int AD_gravity=0,gravity_error;
	for(i=0;i<10;i++)
	{
		AD_gravity+=AD_Capture(1)*0.1;
	}
	//利用反三角函数做归一化
	if((gravity_zero - AD_gravity)>810)
		gravity_error = 810;
	else if((gravity_zero - AD_gravity)<-810)
		gravity_error = -810;
	else gravity_error = gravity_zero - AD_gravity;
	gravity = (asinf((gravity_error)/810.0))*57.2957;
	
	//gravity = (gravity_zero - AD_gravity)*0.1058;//线性归一化,参数要重新调整，现在效果不好
}
//------------------------------------------------------
//获取当前陀螺仪得出的角速度值(正为向前转)
//------------------------------------------------------
void Get_Gyro(void)
{
	uint8 i;
	int AD_gyro=0;
	for(i=0;i<10;i++)
	{
		AD_gyro+=AD_Capture(0)*0.1;
	}
	gyro = (AD_gyro - gyro_zero)*0.45;
}
//------------------------------------------------------
//利用角速度积分计算角度，整定角速度的系数用
//------------------------------------------------------
void Get_Gyro_Angle()
{
	float dt = 0.005;
	angle_gyro += gyro * dt;
}
//------------------------------------------------------
//计算出角度的PID输出值
//------------------------------------------------------
float Angle_Out()
{
	Angle_PID.Out = Angle_PID.Proportion*(angle-set_angle+Speed_Angle_PID.Out) + Angle_PID.Derivative*gyro;//到底用卡尔曼滤波之后的角速度还是直接获取的角速度还未确定
}